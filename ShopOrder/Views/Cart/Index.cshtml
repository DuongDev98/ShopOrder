@model List<ShopOrder.Models.ItemModel>
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";

    if (Model == null || Model.Count == 0)
    {
        <hr />
        <div class="container">
            <div class="row">
                <div class="alert alert-danger w-100 text-center" role="alert">
                    <h1>Giỏ hàng trống</h1>
                </div>
            </div>
        </div>
        return;
    }
}

<!-- Shoping Cart -->
<form class="p-t-75 p-b-85">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                    <h4 class="mtext-109 cl2 p-b-30 bor12">
                        Chi tiết đặt hàng
                    </h4>

                    <div class="row m-t-20">
                        @{
                            decimal tongCong = 0;
                            if (Model != null && Model.Count > 0)
                            {
                                foreach (var item in Model)
                                {
                                    <div class="col-sm-12 col-lg-6 col-xl-4 ">
                                        <div class="card" data-dmathangid="@item.DMATHANGID" data-dsizeid="@item.DSIZEID" data-dmauid="@item.DMAUID">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <img src="/Images/Items/@(item.AVATAR)" alt="IMG" style="width: 100% !important">
                                                    </div>
                                                    <div class="col-8">
                                                        <div class="stext-101">@item.DMATHANG_NAME</div>
                                                        <div id="ipDONGIA" class="stext-105" data-value="@item.DONGIA">@(item.DONGIA.ToString("n0")) vnđ</div>
                                                        <div class="stext-105">Phân loại: @item.DSIZE_NAME (@item.DMAU_NAME)</div>
                                                        <div class="wrap-num-product flex-w m-r-20 m-tb-10">
                                                            <div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m">
                                                                <i class="fs-16 zmdi zmdi-minus"></i>
                                                            </div>
                                                            <input id="ipSOLUONG" class="mtext-104 cl3 txt-center num-product" type="number" name="SOLUONG" value="@item.SOLUONG">
                                                            <div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m">
                                                                <i class="fs-16 zmdi zmdi-plus"></i>
                                                            </div>
                                                        </div>
                                                        <div class="stext-105" style="color:red;"><span id="ipTHANHTIEN">@((item.DONGIA * item.SOLUONG).ToString("n0"))</span> vnđ</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    tongCong += item.DONGIA * item.SOLUONG;
                                }
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
                <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                    <h4 class="mtext-109 cl2 p-b-30">
                        THÔNG TIN
                    </h4>

                    <div class="flex-w flex-t bor12 p-b-13">
                        <div class="size-208">
                            <span class="stext-110 cl2">
                                Subtotal:
                            </span>
                        </div>

                        <div class="size-209">
                            <span class="mtext-110 cl2 ipTONGCONG" style="color:red;">
                                @tongCong.ToString("n0") vnđ
                            </span>
                        </div>
                    </div>

                    <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                        <div class="size-208 w-full-ssm">
                            <span class="stext-110 cl2">
                                Shipping:
                            </span>
                        </div>

                        <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                            <p class="stext-111 cl6 p-t-2">
                                There are no shipping methods available. Please double check your address, or contact us if you need any help.
                            </p>

                            <div class="p-t-15">
                                <span class="stext-112 cl8">
                                    Calculate Shipping
                                </span>

                                <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-12 m-t-9">
                                    <select class="js-select2" name="time">
                                        <option>Select a country...</option>
                                        <option>USA</option>
                                        <option>UK</option>
                                    </select>
                                    <div class="dropDownSelect2"></div>
                                </div>

                                <div class="bor8 bg0 m-b-12">
                                    <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="state" placeholder="State /  country">
                                </div>

                                <div class="bor8 bg0 m-b-22">
                                    <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="postcode" placeholder="Postcode / Zip">
                                </div>

                                <div class="flex-w">
                                    <div class="flex-c-m stext-101 cl2 size-115 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer">
                                        Update Totals
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="flex-w flex-t p-t-27 p-b-33">
                        <div class="size-208">
                            <span class="mtext-101 cl2">
                                Total:
                            </span>
                        </div>

                        <div class="size-209 p-t-1">
                            <span class="mtext-110 cl2 ipTONGCONG" style="color:red;">
                                @tongCong.ToString("n0") vnđ
                            </span>
                        </div>
                    </div>

                    <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
<script>
    $('.btn-num-product-up').click(function (e) {
        e.preventDefault();
        ThayDoiSoLuong($(this), 1);
    });

    $('.btn-num-product-down').click(function (e) {
        e.preventDefault();
        ThayDoiSoLuong($(this), -1);
    });

    function ThayDoiSoLuong(btn, value) {
        let card = btn.closest('.card');
        let dmathangid = card.attr('data-dmathangid');
        let dsizeid = card.attr('data-dsizeid');
        let dmauid = card.attr('data-dmauid');
        let donGia = parseInt(card.find('#ipDONGIA').attr('data-value'));
        let soLuong = parseInt(card.find('#ipSOLUONG').val()) + value;
        let thanhTien = donGia * soLuong;
        if (soLuong < 0) return;

        //cập nhật vào dữ liệu
        let data = [{ name: "DMATHANGID", value: dmathangid }, { name: "DSIZEID", value: dsizeid }, { name: "DMAUID", value: dmauid },
        { name: "DONGIA", value: donGia }, { name: "SOLUONG", value: soLuong }];

        $.post("/Cart/ThayDoiSoLuong", data, function (success) {
            if (success == "ok") {
                //thay đổi thành tiền, thay đổi số lượng
                card.find('#ipSOLUONG').val(soLuong);
                card.find('#ipTHANHTIEN').text(formatNumber(thanhTien));
                //thay đổi tổng cộng
                ThayDoiTongCong();
            } else {
                swal("", success, "error");
            }
        });

        function ThayDoiTongCong() {
            let tongCong = 0;
            $('.card').each(function (index) {
                let donGia = parseInt($(this).find('#ipDONGIA').attr('data-value'));
                let soLuong = parseInt($(this).find('#ipSOLUONG').val());
                tongCong += donGia * soLuong;
            });
            $('.ipTONGCONG').text(formatNumber(tongCong) + ' vnđ');
        }

        function formatNumber(text) {
            var tmp = Int(text + '') + '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(tmp)) {
                tmp = tmp.replace(rgx, '$1' + ',' + '$2');
            }
            return tmp;
        }

        function Int(text) {
            if (text == null || text == undefined || text.trim() == '') return 0;
            var tmp = (text + '').trim();
            while (tmp.indexOf(',') >= 0) {
                tmp = tmp.replace(',', '');
            }
            return parseInt(tmp);
        }
    }
</script>